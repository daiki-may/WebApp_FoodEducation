// document.addEventListener("DOMContentLoaded", function () {
//     const fruitImages = document.querySelectorAll(".fruit");
//     const experimentButtons = document.querySelectorAll(".experiment-btn");
//     const preloadVideosContainer = document.getElementById("preload-videos");
//     const loadingScreen = document.getElementById("loading-screen");
//     const progressBar = document.getElementById("progress-bar");
//     let selectedExperiment = null;
//     let preloadedVideos = {};
//     let loadedVideos = 0;
//     let totalVideos = 0;
//     let currentPlayingVideo = null; // ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª
//     let startTime = null;
//     let progress = 0;
//     let animationFrameId = null;
//     let firstLoadTime = null;
//     let estimatedTotalTime = null;

//     // üéØ Experiment „Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàÂãïÁîª„ÇíÂº∑Âà∂ÂÅúÊ≠¢ & ÂÆüÈ®ì„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÔºâ
//     experimentButtons.forEach(button => {
//         button.addEventListener("click", function () {
//             selectedExperiment = this.getAttribute("data-experiment");

//             // üî¥ ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÂÅúÊ≠¢„Åó„Å¶„É™„Çª„ÉÉ„Éà
//             if (currentPlayingVideo) {
//                 resetVideo(currentPlayingVideo);
//             }

//             // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
//             experimentButtons.forEach(btn => btn.classList.remove("selected"));
//             this.classList.add("selected");
//         });
//     });

//     // üé¨ ‰∫ãÂâç„Å´ÂãïÁîª„Çí„É≠„Éº„Éâ„Åó„ÄÅÈÄ≤Êçó„ÇíË°®Á§∫
//     function preloadVideos() {
//         const promises = [];
//         startTime = performance.now();

//         fruitImages.forEach(fruit => {
//             experimentButtons.forEach(button => {
//                 const exp = button.getAttribute("data-experiment");
//                 const videoUrl = fruit.getAttribute(`data-video-${exp}`);

//                 if (videoUrl && !preloadedVideos[videoUrl]) {
//                     totalVideos++;
//                     const video = document.createElement("video");
//                     video.src = videoUrl;
//                     video.preload = "auto";
//                     video.muted = true;
//                     video.loop = false;
//                     video.style.display = "none";
//                     video.style.zIndex = "-1";
//                     video.setAttribute("data-video", videoUrl);
//                     preloadVideosContainer.appendChild(video);
//                     preloadedVideos[videoUrl] = video;

//                     // üé¨ ÊúÄÂàù„ÅÆÂãïÁîª„ÅÆ„É≠„Éº„ÉâÊôÇÈñì„ÇíÊ∏¨ÂÆö
//                     const videoLoadPromise = new Promise(resolve => {
//                         video.addEventListener("canplaythrough", () => {
//                             if (firstLoadTime === null) {
//                                 firstLoadTime = performance.now() - startTime;
//                                 estimatedTotalTime = firstLoadTime * totalVideos;
//                                 startProgressAnimation(estimatedTotalTime);
//                             }
//                             loadedVideos++;
//                             updateActualProgress();
//                             resolve();
//                         });
//                     });

//                     promises.push(videoLoadPromise);
//                 }
//             });
//         });

//         // üî¥ „Åô„Åπ„Å¶„ÅÆÂãïÁîª„Åå„É≠„Éº„ÉâÂÆå‰∫Ü„Åó„Åü„Çâ Now Loading... „ÇíÊ∂à„Åô
//         Promise.all(promises).then(() => {
//             cancelAnimationFrame(animationFrameId);
//             progressBar.style.width = "100%";
//             setTimeout(() => {
//                 loadingScreen.style.opacity = "0";
//                 setTimeout(() => {
//                     loadingScreen.style.display = "none";
//                 }, 500);
//             }, 500);
//         });
//     }

//     // üîµ ÈÄ≤Êçó„Éê„Éº„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
//     function startProgressAnimation(totalTime) {
//         let startAnimationTime = performance.now();

//         function updateProgress() {
//             let currentTime = performance.now();
//             let elapsed = currentTime - startAnimationTime;
//             let estimatedProgress = Math.min((elapsed / totalTime) * 100, 100);
//             let actualProgress = (loadedVideos / totalVideos) * 100;

//             progress = Math.max(progress, estimatedProgress, actualProgress);
//             progressBar.style.width = `${progress}%`;

//             if (progress < 100) {
//                 animationFrameId = requestAnimationFrame(updateProgress);
//             }
//         }
//         animationFrameId = requestAnimationFrame(updateProgress);
//     }

//     // üîµ ÂÆüÈöõ„ÅÆÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞ÔºàÂãïÁîª„Åî„Å®Ôºâ
//     function updateActualProgress() {
//         let actualProgress = (loadedVideos / totalVideos) * 100;
//         progress = Math.max(progress, actualProgress);
//         progressBar.style.width = `${progress}%`;
//     }

//     // üçì „Éï„É´„Éº„ÉÑÁîªÂÉè„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Å®ÁÑ°ÂäπÔºâ
//     fruitImages.forEach(fruit => {
//         fruit.addEventListener("click", function () {
//             if (!selectedExperiment) {
//                 alert("Please select an experiment first!");
//                 return;
//             }

//             const videoUrl = this.getAttribute(`data-video-${selectedExperiment}`);
//             const duration = parseInt(this.getAttribute(`data-duration`), 10) || 50000;

//             if (!videoUrl) return;

//             // üî¥ ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÂÅúÊ≠¢„Åó„Å¶„É™„Çª„ÉÉ„Éà
//             if (currentPlayingVideo) {
//                 resetVideo(currentPlayingVideo);
//             }

//             // „Åô„Åπ„Å¶„ÅÆ‰∫ãÂâç„É≠„Éº„ÉâÂãïÁîª„ÇíÈö†„Åô
//             Object.values(preloadedVideos).forEach(video => {
//                 video.style.display = "none";
//                 video.style.zIndex = "-1";
//                 video.pause();
//             });

//             // üé¨ ÈÅ∏Êäû„Åó„ÅüÂãïÁîª„Çí `front.png` „ÅÆÂâç„Å´Ë°®Á§∫
//             const selectedVideo = preloadedVideos[videoUrl];
//             if (selectedVideo) {
//                 selectedVideo.style.display = "block";
//                 selectedVideo.style.zIndex = "2";
//                 selectedVideo.muted = false;
//                 selectedVideo.play().catch(error => {
//                     console.warn("Playback failed, retrying:", error);
//                     selectedVideo.muted = false;
//                     selectedVideo.play();
//                 });

//                 // ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„ÇíÊõ¥Êñ∞
//                 currentPlayingVideo = selectedVideo;
//             }

//             // ‚úÖ ÂãïÁîªÁµÇ‰∫ÜÊôÇ„Å´ÈùûË°®Á§∫„Å´„Åô„Çã
//             selectedVideo.onended = function () {
//                 hideVideo(selectedVideo);
//             };

//             // ‚è≥ ÊåáÂÆöÊôÇÈñìÂæå„Å´ÂãïÁîª„ÇíÈùûË°®Á§∫
//             setTimeout(() => {
//                 hideVideo(selectedVideo);
//             }, duration);
//         });
//     });

//     // üéØ ÂãïÁîª„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
//     function hideVideo(video) {
//         video.pause();
//         video.style.display = "none";
//         video.style.zIndex = "-1";
//         video.currentTime = 0; // üî¥ Ê¨°ÂõûÂÜçÁîüÊôÇ„ÅØÊúÄÂàù„Åã„Çâ
//         currentPlayingVideo = null;
//     }

//     // üéØ ÂãïÁîª„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞ÔºàÈÄî‰∏≠„ÅßÊ≠¢„ÇÅ„Çâ„Çå„ÅüÂ†¥Âêà„Å´ÊúÄÂàù„Å´Êàª„ÅôÔºâ
//     function resetVideo(video) {
//         video.pause();
//         video.currentTime = 0; // üî¥ ÈÄî‰∏≠ÂÜçÁîü„ÅÆ„Åæ„Åæ„Å´„Åó„Å™„ÅÑ
//         video.style.display = "none";
//         video.style.zIndex = "-1";
//     }

//     preloadVideos();
// });

document.addEventListener("DOMContentLoaded", function () {
    const fruitImages = document.querySelectorAll(".fruit");
    const preloadVideosContainer = document.getElementById("preload-videos");
    const loadingScreen = document.getElementById("loading-screen");
    const progressBar = document.getElementById("progress-bar");
    const videoContainer = document.getElementById("video-container");
    const videoElement = document.getElementById("experiment-video");
    const videoSource = document.getElementById("video-source");

    let selectedExperiment = null;
    let preloadedVideos = {};
    let loadedVideos = 0;
    let totalVideos = 0;
    let currentPlayingVideo = null;

    // üåü „Éñ„É©„É≥„ÉÅÂêç„Åî„Å®„Å´ÂÆüÈ®ì„É¢„Éº„Éâ„ÇíË®≠ÂÆö
    const hostname = window.location.hostname;
    if (hostname.includes("experiment-1")) {
        selectedExperiment = "V_German";
    } else if (hostname.includes("experiment-2")) {
        selectedExperiment = "VV_German";
    } else if (hostname.includes("experiment-3")) {
        selectedExperiment = "VVP_German";
    } else {
        selectedExperiment = "V_German"; // „Éá„Éï„Ç©„É´„ÉàÔºà„É≠„Éº„Ç´„É´ or mainÔºâ
    }

    console.log(`Selected experiment: ${selectedExperiment}`);

    // üé¨ ‰∫ãÂâç„Å´ÂãïÁîª„Çí„É≠„Éº„ÉâÔºàex3„Å™„ÇâVVP_German„ÅÆ„Åø„É≠„Éº„ÉâÔºâ
    function preloadVideos() {
        const promises = [];
        loadedVideos = 0;  // ÂàùÊúüÂåñ
        totalVideos = 0;    // ÂàùÊúüÂåñ

        fruitImages.forEach(fruit => {
            const videoUrl = fruit.getAttribute(`data-video-${selectedExperiment}`);
            if (videoUrl && !preloadedVideos[videoUrl]) {
                totalVideos++;
                const video = document.createElement("video");
                video.src = videoUrl;
                video.preload = "auto";
                video.muted = true;
                video.loop = false;
                video.style.display = "none";
                video.setAttribute("data-video", videoUrl);
                preloadVideosContainer.appendChild(video);
                preloadedVideos[videoUrl] = video;

                const videoLoadPromise = new Promise(resolve => {
                    video.addEventListener("canplaythrough", () => {
                        loadedVideos++;
                        updateProgressBar();
                        resolve();
                    });
                });

                promises.push(videoLoadPromise);
            }
        });

        // üéØ „Åô„Åπ„Å¶„ÅÆÂãïÁîª„Åå„É≠„Éº„Éâ„Åï„Çå„Åü„Çâ„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈùûË°®Á§∫
        Promise.all(promises).then(() => {
            console.log("All videos preloaded successfully.");
            setTimeout(() => {
                loadingScreen.style.opacity = "0";
                setTimeout(() => {
                    loadingScreen.style.display = "none";
                }, 500);
            }, 500);
        });
    }

    // üéØ ÈÄ≤Êçó„Éê„Éº„ÅÆÊõ¥Êñ∞
    function updateProgressBar() {
        let progress = (loadedVideos / totalVideos) * 100;
        progressBar.style.width = `${progress}%`;
    }

    // üçì „Éï„É´„Éº„ÉÑÁîªÂÉè„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    fruitImages.forEach(fruit => {
        fruit.addEventListener("click", function () {
            const videoUrl = this.getAttribute(`data-video-${selectedExperiment}`);
            if (!videoUrl) {
                console.error("ÂãïÁîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:", this);
                return;
            }

            // üî¥ ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞ÂÅúÊ≠¢
            if (currentPlayingVideo) {
                resetVideo(currentPlayingVideo);
            }

            // üé¨ ÂãïÁîª„Çí„Çª„ÉÉ„Éà„Åó„Å¶ÂÜçÁîü
            videoSource.src = videoUrl;
            videoElement.load();  // **„Åì„Çå„ÅßÊñ∞„Åó„ÅÑÂãïÁîª„ÇíÁ¢∫ÂÆü„Å´„É≠„Éº„Éâ**
            videoElement.play();  // **Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÁ¢∫ÂÆü„Å´ÂÜçÁîü**

            // ‚úÖ **ÂãïÁîª„ÇíË°®Á§∫**
            videoContainer.style.display = "block";  // `display: none;` „ÇíËß£Èô§
            videoContainer.style.zIndex = "5";      // `z-index` „Çí‰∏ä„Åí„Å¶ÂâçÈù¢„Å´Ë°®Á§∫

            // ÁèæÂú®„ÅÆÂãïÁîª„ÇíÊõ¥Êñ∞
            currentPlayingVideo = videoElement;

            // ‚úÖ ÂãïÁîªÁµÇ‰∫ÜÊôÇ„Å´ÈùûË°®Á§∫
            videoElement.onended = function () {
                hideVideo(videoElement);
            };
        });
    });

    // üéØ ÂãïÁîª„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
    function hideVideo(video) {
        video.pause();
        video.style.display = "none";
        videoContainer.style.display = "none";  // **ÂãïÁîª„Ç≥„É≥„ÉÜ„Éä„ÇÇÈùûË°®Á§∫„Å´**
        video.currentTime = 0;
        currentPlayingVideo = null;
    }

    // üéØ ÂãïÁîª„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞
    function resetVideo(video) {
        video.pause();
        video.currentTime = 0;
        video.style.display = "none";
        videoContainer.style.display = "none";  // **ÂãïÁîª„Ç≥„É≥„ÉÜ„Éä„ÇÇÈùûË°®Á§∫„Å´**
    }

    preloadVideos();
});
