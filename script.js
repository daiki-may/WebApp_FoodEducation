// document.addEventListener("DOMContentLoaded", function () {
//     const fruitImages = document.querySelectorAll(".fruit");
//     const experimentButtons = document.querySelectorAll(".experiment-btn");
//     const preloadVideosContainer = document.getElementById("preload-videos");
//     const loadingScreen = document.getElementById("loading-screen");
//     const progressBar = document.getElementById("progress-bar");
//     let selectedExperiment = null;
//     let preloadedVideos = {};
//     let loadedVideos = 0;
//     let totalVideos = 0;
//     let currentPlayingVideo = null; // ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª
//     let startTime = null;
//     let progress = 0;
//     let animationFrameId = null;
//     let firstLoadTime = null;
//     let estimatedTotalTime = null;

//     // üéØ Experiment „Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàÂãïÁîª„ÇíÂº∑Âà∂ÂÅúÊ≠¢ & ÂÆüÈ®ì„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÔºâ
//     experimentButtons.forEach(button => {
//         button.addEventListener("click", function () {
//             selectedExperiment = this.getAttribute("data-experiment");

//             // üî¥ ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÂÅúÊ≠¢„Åó„Å¶„É™„Çª„ÉÉ„Éà
//             if (currentPlayingVideo) {
//                 resetVideo(currentPlayingVideo);
//             }

//             // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
//             experimentButtons.forEach(btn => btn.classList.remove("selected"));
//             this.classList.add("selected");
//         });
//     });

//     // üé¨ ‰∫ãÂâç„Å´ÂãïÁîª„Çí„É≠„Éº„Éâ„Åó„ÄÅÈÄ≤Êçó„ÇíË°®Á§∫
//     function preloadVideos() {
//         const promises = [];
//         startTime = performance.now();

//         fruitImages.forEach(fruit => {
//             experimentButtons.forEach(button => {
//                 const exp = button.getAttribute("data-experiment");
//                 const videoUrl = fruit.getAttribute(`data-video-${exp}`);

//                 if (videoUrl && !preloadedVideos[videoUrl]) {
//                     totalVideos++;
//                     const video = document.createElement("video");
//                     video.src = videoUrl;
//                     video.preload = "auto";
//                     video.muted = true;
//                     video.loop = false;
//                     video.style.display = "none";
//                     video.style.zIndex = "-1";
//                     video.setAttribute("data-video", videoUrl);
//                     preloadVideosContainer.appendChild(video);
//                     preloadedVideos[videoUrl] = video;

//                     // üé¨ ÊúÄÂàù„ÅÆÂãïÁîª„ÅÆ„É≠„Éº„ÉâÊôÇÈñì„ÇíÊ∏¨ÂÆö
//                     const videoLoadPromise = new Promise(resolve => {
//                         video.addEventListener("canplaythrough", () => {
//                             if (firstLoadTime === null) {
//                                 firstLoadTime = performance.now() - startTime;
//                                 estimatedTotalTime = firstLoadTime * totalVideos;
//                                 startProgressAnimation(estimatedTotalTime);
//                             }
//                             loadedVideos++;
//                             updateActualProgress();
//                             resolve();
//                         });
//                     });

//                     promises.push(videoLoadPromise);
//                 }
//             });
//         });

//         // üî¥ „Åô„Åπ„Å¶„ÅÆÂãïÁîª„Åå„É≠„Éº„ÉâÂÆå‰∫Ü„Åó„Åü„Çâ Now Loading... „ÇíÊ∂à„Åô
//         Promise.all(promises).then(() => {
//             cancelAnimationFrame(animationFrameId);
//             progressBar.style.width = "100%";
//             setTimeout(() => {
//                 loadingScreen.style.opacity = "0";
//                 setTimeout(() => {
//                     loadingScreen.style.display = "none";
//                 }, 500);
//             }, 500);
//         });
//     }

//     // üîµ ÈÄ≤Êçó„Éê„Éº„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
//     function startProgressAnimation(totalTime) {
//         let startAnimationTime = performance.now();

//         function updateProgress() {
//             let currentTime = performance.now();
//             let elapsed = currentTime - startAnimationTime;
//             let estimatedProgress = Math.min((elapsed / totalTime) * 100, 100);
//             let actualProgress = (loadedVideos / totalVideos) * 100;

//             progress = Math.max(progress, estimatedProgress, actualProgress);
//             progressBar.style.width = `${progress}%`;

//             if (progress < 100) {
//                 animationFrameId = requestAnimationFrame(updateProgress);
//             }
//         }
//         animationFrameId = requestAnimationFrame(updateProgress);
//     }

//     // üîµ ÂÆüÈöõ„ÅÆÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞ÔºàÂãïÁîª„Åî„Å®Ôºâ
//     function updateActualProgress() {
//         let actualProgress = (loadedVideos / totalVideos) * 100;
//         progress = Math.max(progress, actualProgress);
//         progressBar.style.width = `${progress}%`;
//     }

//     // üçì „Éï„É´„Éº„ÉÑÁîªÂÉè„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Å®ÁÑ°ÂäπÔºâ
//     fruitImages.forEach(fruit => {
//         fruit.addEventListener("click", function () {
//             if (!selectedExperiment) {
//                 alert("Please select an experiment first!");
//                 return;
//             }

//             const videoUrl = this.getAttribute(`data-video-${selectedExperiment}`);
//             const duration = parseInt(this.getAttribute(`data-duration`), 10) || 50000;

//             if (!videoUrl) return;

//             // üî¥ ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÂÅúÊ≠¢„Åó„Å¶„É™„Çª„ÉÉ„Éà
//             if (currentPlayingVideo) {
//                 resetVideo(currentPlayingVideo);
//             }

//             // „Åô„Åπ„Å¶„ÅÆ‰∫ãÂâç„É≠„Éº„ÉâÂãïÁîª„ÇíÈö†„Åô
//             Object.values(preloadedVideos).forEach(video => {
//                 video.style.display = "none";
//                 video.style.zIndex = "-1";
//                 video.pause();
//             });

//             // üé¨ ÈÅ∏Êäû„Åó„ÅüÂãïÁîª„Çí `front.png` „ÅÆÂâç„Å´Ë°®Á§∫
//             const selectedVideo = preloadedVideos[videoUrl];
//             if (selectedVideo) {
//                 selectedVideo.style.display = "block";
//                 selectedVideo.style.zIndex = "2";
//                 selectedVideo.muted = false;
//                 selectedVideo.play().catch(error => {
//                     console.warn("Playback failed, retrying:", error);
//                     selectedVideo.muted = false;
//                     selectedVideo.play();
//                 });

//                 // ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„ÇíÊõ¥Êñ∞
//                 currentPlayingVideo = selectedVideo;
//             }

//             // ‚úÖ ÂãïÁîªÁµÇ‰∫ÜÊôÇ„Å´ÈùûË°®Á§∫„Å´„Åô„Çã
//             selectedVideo.onended = function () {
//                 hideVideo(selectedVideo);
//             };

//             // ‚è≥ ÊåáÂÆöÊôÇÈñìÂæå„Å´ÂãïÁîª„ÇíÈùûË°®Á§∫
//             setTimeout(() => {
//                 hideVideo(selectedVideo);
//             }, duration);
//         });
//     });

//     // üéØ ÂãïÁîª„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
//     function hideVideo(video) {
//         video.pause();
//         video.style.display = "none";
//         video.style.zIndex = "-1";
//         video.currentTime = 0; // üî¥ Ê¨°ÂõûÂÜçÁîüÊôÇ„ÅØÊúÄÂàù„Åã„Çâ
//         currentPlayingVideo = null;
//     }

//     // üéØ ÂãïÁîª„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞ÔºàÈÄî‰∏≠„ÅßÊ≠¢„ÇÅ„Çâ„Çå„ÅüÂ†¥Âêà„Å´ÊúÄÂàù„Å´Êàª„ÅôÔºâ
//     function resetVideo(video) {
//         video.pause();
//         video.currentTime = 0; // üî¥ ÈÄî‰∏≠ÂÜçÁîü„ÅÆ„Åæ„Åæ„Å´„Åó„Å™„ÅÑ
//         video.style.display = "none";
//         video.style.zIndex = "-1";
//     }

//     preloadVideos();
// });


// #######################################################################

document.addEventListener("DOMContentLoaded", function () {
    const fruitImages = document.querySelectorAll(".fruit");
    const experimentButtons = document.querySelectorAll(".experiment-btn");
    const preloadVideosContainer = document.getElementById("preload-videos");
    const loadingScreen = document.getElementById("loading-screen");
    const progressBar = document.getElementById("progress-bar");
    let selectedExperiment = "VVP_German"; // ‚úÖ Ex3„Çí„Éá„Éï„Ç©„É´„ÉàÈÅ∏Êäû
    let preloadedVideos = {};
    let loadedVideos = 0;
    let totalVideos = 0;
    let currentPlayingVideo = null;

    // ‚úÖ ÂàùÊúüÁä∂ÊÖã„Åß Ex3 „Éú„Çø„É≥„ÇíÈÅ∏Êäû„ÄÅ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅØÁÑ°ÂäπÂåñ
    experimentButtons.forEach(button => {
        const exp = button.getAttribute("data-experiment");
        if (exp !== "VVP_German") {
            button.classList.add("disabled");
            button.disabled = true;
        } else {
            button.classList.add("selected");
        }
    });

    // üéØ Experiment „Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàEx3 ‰ª•Â§ñ„ÅØ„ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØÔºâ
    experimentButtons.forEach(button => {
        button.addEventListener("click", function () {
            if (this.classList.contains("disabled")) return; // üö´ ÁÑ°ÂäπÂåñ„Åï„Çå„Åü„Éú„Çø„É≥„ÅØÁÑ°Ë¶ñ

            selectedExperiment = this.getAttribute("data-experiment");

            // üî¥ ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÁµÇ‰∫Ü
            if (currentPlayingVideo) {
                resetVideo(currentPlayingVideo);
            }

            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            experimentButtons.forEach(btn => btn.classList.remove("selected"));
            this.classList.add("selected");
        });
    });

    // üé¨ ‰∫ãÂâç„Å´ Ex3 „ÅÆÂãïÁîª 6 „Å§„Çí„É≠„Éº„Éâ„Åó„ÄÅÈÄ≤Êçó„ÇíË°®Á§∫
    function preloadVideos() {
        const promises = [];
        let startTime = performance.now();

        fruitImages.forEach(fruit => {
            const videoUrl = fruit.getAttribute(`data-video-VVP_German`); // ‚úÖ Ex3 „ÅÆ„Åø
            if (videoUrl && !preloadedVideos[videoUrl]) {
                totalVideos++;
                const video = document.createElement("video");
                video.src = videoUrl;
                video.preload = "auto";
                video.muted = true;
                video.loop = false;
                video.style.display = "none";
                video.style.zIndex = "-1";
                video.setAttribute("data-video", videoUrl);
                preloadVideosContainer.appendChild(video);
                preloadedVideos[videoUrl] = video;

                // üé¨ ÊúÄÂàù„ÅÆÂãïÁîª„ÅÆ„É≠„Éº„ÉâÊôÇÈñì„ÇíÊ∏¨ÂÆö
                const videoLoadPromise = new Promise(resolve => {
                    video.addEventListener("canplaythrough", () => {
                        loadedVideos++;
                        updateActualProgress();
                        resolve();
                    });
                });

                promises.push(videoLoadPromise);
            }
        });

        // üî¥ „Åô„Åπ„Å¶„ÅÆÂãïÁîª„Åå„É≠„Éº„ÉâÂÆå‰∫Ü„Åó„Åü„Çâ Now Loading... „ÇíÊ∂à„Åô
        Promise.all(promises).then(() => {
            if (progressBar) {
                progressBar.style.width = "100%";
            }
            setTimeout(() => {
                if (loadingScreen) {
                    loadingScreen.style.opacity = "0";
                    setTimeout(() => {
                        loadingScreen.style.display = "none";
                    }, 500);
                }
            }, 500);
        });
    }

    // üîµ ÂÆüÈöõ„ÅÆÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞ÔºàÂãïÁîª„Åî„Å®Ôºâ
    function updateActualProgress() {
        if (progressBar) {
            let actualProgress = (loadedVideos / totalVideos) * 100;
            progressBar.style.width = `${actualProgress}%`;
        }
    }

    // üçì „Éï„É´„Éº„ÉÑÁîªÂÉè„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàEx3 ‰ª•Â§ñ„ÅØÁÑ°ÂäπÔºâ
    fruitImages.forEach(fruit => {
        fruit.addEventListener("click", function () {
            if (selectedExperiment !== "VVP_German") return; // üö´ Ex3 ‰ª•Â§ñ„Åß„ÅØ„ÇØ„É™„ÉÉ„ÇØÁÑ°Âäπ

            const videoUrl = this.getAttribute(`data-video-${selectedExperiment}`);
            const duration = parseInt(this.getAttribute(`data-duration`), 10) || 50000;

            if (!videoUrl) return;

            // üî¥ ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÁµÇ‰∫Ü
            if (currentPlayingVideo) {
                resetVideo(currentPlayingVideo);
            }

            // „Åô„Åπ„Å¶„ÅÆ‰∫ãÂâç„É≠„Éº„ÉâÂãïÁîª„ÇíÈö†„Åô
            Object.values(preloadedVideos).forEach(video => {
                video.style.display = "none";
                video.style.zIndex = "-1";
                video.pause();
            });

            // üé¨ ÈÅ∏Êäû„Åó„ÅüÂãïÁîª„Çí `front.png` „ÅÆÂâç„Å´Ë°®Á§∫
            const selectedVideo = preloadedVideos[videoUrl];
            if (selectedVideo) {
                selectedVideo.style.display = "block";
                selectedVideo.style.zIndex = "2";
                selectedVideo.muted = false;
                selectedVideo.play().catch(error => {
                    console.warn("Playback failed, retrying:", error);
                    selectedVideo.muted = false;
                    selectedVideo.play();
                });

                // ÁèæÂú®ÂÜçÁîü‰∏≠„ÅÆÂãïÁîª„ÇíÊõ¥Êñ∞
                currentPlayingVideo = selectedVideo;
            }

            // ‚úÖ ÂãïÁîªÁµÇ‰∫ÜÊôÇ„Å´ÈùûË°®Á§∫„Å´„Åô„Çã
            selectedVideo.onended = function () {
                hideVideo(selectedVideo);
            };

            // ‚è≥ ÊåáÂÆöÊôÇÈñìÂæå„Å´ÂãïÁîª„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                hideVideo(selectedVideo);
            }, duration);
        });
    });

    // üéØ ÂãïÁîª„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
    function hideVideo(video) {
        video.pause();
        video.style.display = "none";
        video.style.zIndex = "-1";
        video.currentTime = 0; // üî¥ Ê¨°ÂõûÂÜçÁîüÊôÇ„ÅØÊúÄÂàù„Åã„Çâ
        currentPlayingVideo = null;
    }

    // üéØ ÂãïÁîª„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞ÔºàÈÄî‰∏≠„ÅßÊ≠¢„ÇÅ„Çâ„Çå„ÅüÂ†¥Âêà„Å´ÊúÄÂàù„Å´Êàª„ÅôÔºâ
    function resetVideo(video) {
        video.pause();
        video.currentTime = 0; // üî¥ ÈÄî‰∏≠ÂÜçÁîü„ÅÆ„Åæ„Åæ„Å´„Åó„Å™„ÅÑ
        video.style.display = "none";
        video.style.zIndex = "-1";
    }

    preloadVideos();
});

